---
import type { Lang } from '../../i18n';
import { useTranslations, getLocalizedPath } from '../../i18n';
import { blogT } from '../../i18n/pages/blog';
import { formatDate } from '../../lib/blogger';
import CommentSection from '../react/blog/CommentSection';

interface Props {
  lang: Lang;
  post: any;
  postId: string;
  comments: any[];
  commentsPageToken?: string;
  error: string | null;
  image: string | null;
  readingTime: number;
  googleClientId: string;
}

const { lang, post, postId, comments, commentsPageToken, error, image, readingTime, googleClientId } = Astro.props;
const t = useTranslations(blogT);
const blogPath = getLocalizedPath('/blog', lang);
const locale = lang === 'en' ? 'en-US' : 'es-ES';
const commentTranslations = {
  title: t(lang, 'comments.title'),
  signIn: t(lang, 'comments.signIn'),
  signingIn: t(lang, 'comments.signingIn'),
  signOut: t(lang, 'comments.signOut'),
  placeholder: t(lang, 'comments.placeholder'),
  posting: t(lang, 'comments.posting'),
  post: t(lang, 'comments.post'),
  posted: t(lang, 'comments.posted'),
  failed: t(lang, 'comments.failed'),
  empty: t(lang, 'comments.empty'),
  loadMore: t(lang, 'comments.loadMore'),
  loading: t(lang, 'comments.loading'),
};
---

{googleClientId && (
  <script is:inline src="https://accounts.google.com/gsi/client" async defer></script>
)}

<main id="blog-post-page">
  <div class="post-bg-effects">
    <div class="post-orb orb-1"></div>
    <div class="post-orb orb-2"></div>
  </div>

  <div class="post-container">
    {error || !post ? (
      <div class="post-error">
        <p class="error-title">{t(lang, 'post.notFound')}</p>
        <p class="error-text">{error || t(lang, 'post.notFoundText')}</p>
        <a href={blogPath} class="back-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
          {t(lang, 'post.backToBlog')}
        </a>
      </div>
    ) : (
      <>
        <a href={blogPath} class="back-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
          {t(lang, 'post.backToBlog')}
        </a>

        <article class="post-article">
          {image && (
            <div class="post-hero-image">
              <img src={image} alt={post.title} />
            </div>
          )}

          <header class="post-header">
            {post.labels && post.labels.length > 0 && (
              <div class="post-labels">
                {post.labels.map((label: string) => (
                  <a href={`${blogPath}?label=${encodeURIComponent(label)}`} class="post-label">
                    {label}
                  </a>
                ))}
              </div>
            )}

            <h1 class="post-title">{post.title}</h1>

            <div class="post-meta">
              <div class="post-author">
                {post.author.image?.url && (
                  <img
                    src={post.author.image.url}
                    alt={post.author.displayName}
                    class="author-avatar"
                  />
                )}
                <span class="author-name">{post.author.displayName}</span>
              </div>
              <span class="meta-separator">|</span>
              <span class="post-date">{formatDate(post.published, locale)}</span>
              <span class="meta-separator">|</span>
              <span class="post-reading-time">{readingTime} {t(lang, 'post.minRead')}</span>
            </div>
          </header>

          <div class="post-content" set:html={post.content} />
        </article>

        <section class="comments-section">
          <CommentSection
            client:idle
            postId={postId}
            initialComments={comments}
            initialPageToken={commentsPageToken}
            totalItems={post.replies?.totalItems}
            googleClientId={googleClientId}
            translations={commentTranslations}
            locale={locale}
          />
        </section>
      </>
    )}
  </div>
</main>

<style>
  #blog-post-page { position: relative; min-height: 100vh; padding: 8rem 2rem 6rem; background: #000000; overflow: hidden; }

  .post-bg-effects { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
  .post-orb { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.25; }
  .post-orb.orb-1 { width: 500px; height: 500px; background: radial-gradient(circle, rgba(59, 130, 246, 0.3) 0%, transparent 70%); top: -200px; left: -150px; }
  .post-orb.orb-2 { width: 400px; height: 400px; background: radial-gradient(circle, rgba(139, 92, 246, 0.2) 0%, transparent 70%); bottom: -100px; right: -100px; }

  .post-container { max-width: 800px; margin: 0 auto; position: relative; z-index: 1; }

  .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: rgba(255, 255, 255, 0.5); font-size: 0.9rem; font-weight: 500; text-decoration: none; margin-bottom: 2.5rem; transition: color 0.3s ease; }
  .back-link:hover { color: #3b82f6; }

  .post-error { text-align: center; padding: 5rem 2rem; }
  .error-title { font-size: 1.5rem; font-weight: 700; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.5rem; }
  .error-text { font-size: 0.95rem; color: rgba(255, 255, 255, 0.35); margin-bottom: 2rem; }

  .post-article { background: linear-gradient(135deg, rgba(15, 15, 20, 0.8) 0%, rgba(10, 10, 15, 0.9) 100%); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 24px; overflow: hidden; backdrop-filter: blur(20px); }

  .post-hero-image { width: 100%; max-height: 400px; overflow: hidden; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
  .post-hero-image img { width: 100%; height: 100%; object-fit: cover; }

  .post-header { padding: 2.5rem 2.5rem 0; }
  .post-labels { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.25rem; }
  .post-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; color: #3b82f6; background: rgba(59, 130, 246, 0.1); padding: 0.3rem 0.8rem; border-radius: 100px; border: 1px solid rgba(59, 130, 246, 0.2); text-decoration: none; transition: all 0.3s ease; }
  .post-label:hover { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); }

  .post-title { font-size: clamp(1.75rem, 4vw, 2.5rem); font-weight: 800; line-height: 1.2; margin-bottom: 1.5rem; background: linear-gradient(135deg, #ffffff 0%, #d0d0d0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .post-meta { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; font-size: 0.85rem; color: rgba(255, 255, 255, 0.4); padding-bottom: 2rem; border-bottom: 1px solid rgba(255, 255, 255, 0.06); }
  .post-author { display: flex; align-items: center; gap: 0.5rem; }
  .author-avatar { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(59, 130, 246, 0.3); }
  .author-name { color: rgba(255, 255, 255, 0.65); font-weight: 600; }
  .meta-separator { color: rgba(255, 255, 255, 0.15); }
  .post-date { font-family: "JetBrains Mono", monospace; font-size: 0.8rem; }
  .post-reading-time { font-family: "JetBrains Mono", monospace; font-size: 0.8rem; }

  .post-content { padding: 2.5rem; color: rgba(255, 255, 255, 0.75); font-size: 1.05rem; line-height: 1.8; }
  .post-content :global(h1), .post-content :global(h2), .post-content :global(h3), .post-content :global(h4), .post-content :global(h5), .post-content :global(h6) { color: #e8e8e8; margin: 2rem 0 1rem; line-height: 1.3; }
  .post-content :global(h2) { font-size: 1.5rem; font-weight: 700; }
  .post-content :global(h3) { font-size: 1.25rem; font-weight: 600; }
  .post-content :global(p) { margin-bottom: 1.5rem; }
  .post-content :global(a) { color: #3b82f6; text-decoration: underline; text-underline-offset: 3px; transition: color 0.2s ease; }
  .post-content :global(a:hover) { color: #60a5fa; }
  .post-content :global(img) { max-width: 100%; height: auto; border-radius: 12px; margin: 1.5rem 0; border: 1px solid rgba(255, 255, 255, 0.05); }
  .post-content :global(ul), .post-content :global(ol) { margin: 1rem 0 1.5rem 1.5rem; }
  .post-content :global(li) { margin-bottom: 0.5rem; }
  .post-content :global(blockquote) { margin: 1.5rem 0; padding: 1rem 1.5rem; border-left: 3px solid #3b82f6; background: rgba(59, 130, 246, 0.05); border-radius: 0 8px 8px 0; color: rgba(255, 255, 255, 0.6); font-style: italic; }
  .post-content :global(pre) { margin: 1.5rem 0; padding: 1.25rem; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; overflow-x: auto; font-family: "JetBrains Mono", "Fira Code", monospace; font-size: 0.9rem; line-height: 1.6; }
  .post-content :global(code) { font-family: "JetBrains Mono", "Fira Code", monospace; font-size: 0.88em; background: rgba(59, 130, 246, 0.1); padding: 0.15rem 0.4rem; border-radius: 4px; color: #60a5fa; }
  .post-content :global(pre code) { background: none; padding: 0; color: inherit; }
  .post-content :global(hr) { margin: 2rem 0; border: none; border-top: 1px solid rgba(255, 255, 255, 0.08); }
  .post-content :global(table) { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
  .post-content :global(th), .post-content :global(td) { padding: 0.75rem 1rem; border: 1px solid rgba(255, 255, 255, 0.08); text-align: left; }
  .post-content :global(th) { background: rgba(255, 255, 255, 0.03); font-weight: 600; color: #e8e8e8; }

  .comments-section { margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, rgba(15, 15, 20, 0.6) 0%, rgba(10, 10, 15, 0.7) 100%); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 24px; backdrop-filter: blur(10px); }

  @media (max-width: 768px) {
    #blog-post-page { padding: 7rem 1rem 4rem; }
    .post-header { padding: 1.5rem 1.5rem 0; }
    .post-content { padding: 1.5rem; font-size: 1rem; }
    .post-meta { font-size: 0.8rem; }
    .comments-section { padding: 1.5rem; }
  }
</style>
